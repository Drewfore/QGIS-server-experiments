<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>NSW LGA Search</title>
  <style>
    /* General page styling */
    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: #f5f7fa;
      margin: 0;
      padding: 0;
      color: #333;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden; /* prevent body scroll */
    }

    /* Sticky search container */
    .search-container {
      position: sticky;
      top: 0;
      background: #ffffff;
	  padding-top:10px;
	  padding-bottom:10px;
     //padding: 1rem 2rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      z-index: 10;
    }

    h1 {
      margin: 0;
      font-size: 1.8rem;
      color: #1f3c88;
      text-align: center;
    }

    p {
      font-size: 1rem;
      color: #555;
      text-align: center;
      margin: 0.25rem 0 1rem 0;
    }

    input {
      padding: 0.6rem 1rem;
      margin:2%;
	  width: 90%;
      border: 2px solid #ccc;
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.3s;
      outline: none;
    }

    input:focus {
      border-color: #1f3c88;
      box-shadow: 0 0 5px rgba(31, 60, 136, 0.3);
    }

    #status {
      margin-top: 0.5rem;
      font-style: italic;
      color: #777;
      text-align: center;
    }

    /* Scrollable results container */
    .scroll-container {
      flex: 1;
      overflow-y: auto;
      padding: 1rem 2rem;
    }

    ul {
      margin-top: 1rem;
      padding-left: 0;
      list-style: none;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }

    li {
      padding: 0.6rem 1rem;
      cursor: pointer;
      background: #fafafa;
      border-bottom: 1px solid #eee;
      transition: background 0.2s;
    }

    li:last-child {
      border-bottom: none;
    }

    li:hover {
      background: #e6f0ff;
    }

    table {
      margin-top: 1rem;
      border-collapse: collapse;
      width: 100%;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      opacity: 0;
      transform: translateY(10px);
      transition: opacity 0.3s ease, transform 0.3s ease;
    }

    table.fade-in {
      opacity: 1;
      transform: translateY(0);
    }

    th, td {
      border: none;
      padding: 0.75rem 1rem;
      text-align: left;
    }

    th {
      background-color: #1f3c88;
      color: #fff;
      font-weight: 600;
    }

    tr:nth-child(even) {
      background-color: #f7f9fc;
    }

    .fade-out {
      opacity: 0;
      transition: opacity 0.3s ease;
    }
  </style>
</head>
<body>
  <div class="search-container">
    <h1>NSW LGA Search</h1>
    <p>Type the name of a Local Government Area</p>
    <input type="text" id="searchBox" placeholder="Search LGA..." />
    <div id="status"></div>
  </div>

  <div class="scroll-container">
    <ul id="results"></ul>
    <div id="details"></div>
  </div>

  <script>
    const searchBox = document.getElementById("searchBox");
    const resultsList = document.getElementById("results");
    const status = document.getElementById("status");
    const detailsDiv = document.getElementById("details");

    let currentController = null;
    let currentFeatures = [];

    async function searchAddresses(query) {
      if (!query) {
        resultsList.innerHTML = "";
        detailsDiv.innerHTML = "";
        status.textContent = "";
        return;
      }

      if (currentController) currentController.abort();
      currentController = new AbortController();
      const { signal } = currentController;

      status.textContent = "Fetching results...";
      resultsList.innerHTML = "";
      detailsDiv.innerHTML = "";

      const url = `http://localhost:80/cgi-bin/qgis_mapserv.fcgi.exe?TYPENAME=localgovernmentarea&LAYERS=localgovernmentarea&STYLES=default&SERVICE=WFS&REQUEST=GetFeature&VERSION=1.1.0&SRSNAME=EPSG:4326&OUTPUTFORMAT=application/json&EXP_FILTER=lganame%20ilike%20'%25${query}%25'&maxfeatures=20&sortBy=address+A`;

      try {
        const response = await fetch(url, { signal });
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const data = await response.json();

        if (!signal.aborted) {
          status.textContent = "";
          resultsList.innerHTML = "";
          currentFeatures = data.features || [];

          if (currentFeatures.length > 0) {
            currentFeatures.forEach((f, idx) => {
              const li = document.createElement("li");
              li.textContent = f.properties.lganame || "No name";
              li.addEventListener("click", () => showDetails(idx));
              resultsList.appendChild(li);
            });
          } else {
            resultsList.innerHTML = "<li>No results</li>";
          }
        }
      } catch (err) {
        if (err.name === "AbortError") return;
        status.textContent = "";
        resultsList.innerHTML = `<li style="color:red;">Error: ${err.message}</li>`;
      }
    }

    function showDetails(index) {
      const feature = currentFeatures[index];
      if (!feature) return;

      resultsList.classList.add("fade-out");

      setTimeout(() => {
        searchBox.value = "";
        resultsList.innerHTML = "";
        resultsList.classList.remove("fade-out");

        const props = feature.properties;
        let html = "<table>";
        html += "<tr><th>Attribute</th><th>Value</th></tr>";
        for (const key in props) {
          html += `<tr><td>${key}</td><td>${props[key]}</td></tr>`;
        }
        html += "</table>";
        detailsDiv.innerHTML = html;

        const table = detailsDiv.querySelector("table");
        setTimeout(() => table.classList.add("fade-in"), 10);
      }, 300);
    }

    function debounce(fn, delay) {
      let timeout;
      return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => fn.apply(this, args), delay);
      };
    }

    const debouncedSearch = debounce((query) => searchAddresses(query), 300);
    searchBox.addEventListener("input", (e) => {
      const query = e.target.value.trim();
      debouncedSearch(query);
    });
  </script>
</body>
</html>
